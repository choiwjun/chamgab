# S03: 검색 결과 (지도)
version: "2.0"

screen:
  id: S03
  name: 검색 결과 (지도)
  route: /search/map
  layout: full-screen
  auth_required: false
  description: 지도 기반 매물 탐색

data_requirements:
  - resource: properties
    needs: [id, name, address, location, thumbnail, area_exclusive]
    filters:
      bounds: "?bounds"  # 지도 영역 (lat_min, lat_max, lng_min, lng_max)
      region: "?region"
      type: "?type"
      price_min: "?price_min"
      price_max: "?price_max"
    description: 지도 영역 내 매물

  - resource: chamgab_analyses
    needs: [property_id, chamgab_price]
    description: 마커에 표시할 참값

components:
  - id: map
    type: kakao-map
    position: full
    function: Kakao Maps 지도
    props:
      initial_center: { lat: 37.5665, lng: 126.978 }  # 서울시청
      initial_zoom: 13
      clustering:
        - zoom_max: 11
          type: district  # 구 단위 클러스터
        - zoom_min: 12
          zoom_max: 13
          type: dong  # 동 단위 클러스터
        - zoom_min: 14
          zoom_max: 15
          type: radius  # 200m 반경 클러스터
        - zoom_min: 16
          type: individual  # 개별 마커
    data_source:
      resource: properties

  - id: filter_overlay
    type: filter-bar
    position: top-overlay
    function: 빠른 필터 (오버레이)
    props:
      compact: true
      filters:
        - id: property_type
          label: 유형
          type: chip-group
        - id: price
          label: 가격
          type: range-chip

  - id: property_preview
    type: bottom-sheet
    position: bottom
    function: 마커 클릭 시 매물 프리뷰
    props:
      trigger: marker_click
      height: 200px
      fields: [thumbnail, name, address, area_exclusive, chamgab_price]
    data_source:
      resource: properties

  - id: view_toggle
    type: fab
    position: bottom-right
    function: 리스트 뷰 전환
    props:
      icon: list
      label: 리스트로 보기

connections:
  - from: map
    action: bounds_change
    to: 새 영역 내 매물 조회

  - from: map.marker
    action: click
    to: property_preview 표시

  - from: property_preview
    action: click
    to: /property/{id}

  - from: view_toggle
    action: click
    to: /search?{current_filters}

  - from: filter_overlay
    action: change
    to: 필터 적용 → 마커 업데이트

tests:
  - name: 초기 로드
    when: /search/map 접속
    then:
      - 지도 서울시청 중심으로 표시
      - 현재 영역 내 매물 마커 표시

  - name: 줌 레벨별 클러스터링
    when: 줌 아웃
    then: 줌 레벨에 따른 클러스터링 적용

  - name: 마커 클릭
    when: 매물 마커 클릭
    then: 하단 시트에 매물 프리뷰 표시

  - name: 영역 이동
    when: 지도 드래그
    then: 새 영역 내 매물 자동 조회
