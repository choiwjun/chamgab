name: Full Data Collection & Training (Immediate)

on:
  workflow_dispatch:
    inputs:
      regions:
        description: 'ìˆ˜ì§‘ ëŒ€ìƒ (all=ì „êµ­, seoul=ì„œìš¸, sample=ìƒ˜í”Œ 10ê°œ)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - seoul
          - sample
      months:
        description: 'ìˆ˜ì§‘ ê¸°ê°„ (ê°œì›”)'
        required: true
        default: '12'
        type: string
      skip_training:
        description: 'ML í•™ìŠµ ê±´ë„ˆë›°ê¸°'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect-all-data:
    name: ì „êµ­ ë°ì´í„° ìˆ˜ì§‘
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2ì‹œê°„ íƒ€ìž„ì•„ì›ƒ

    strategy:
      matrix:
        # ë³‘ë ¬ë¡œ ì‹œë„ë³„ ìˆ˜ì§‘
        region_group: [1, 2, 3, 4, 5]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Collect transaction data (Group ${{ matrix.region_group }})
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          DATA_GO_KR_API_KEY: ${{ secrets.DATA_GO_KR_API_KEY }}
          REGION_GROUP: ${{ matrix.region_group }}
          COLLECTION_MODE: ${{ inputs.regions }}
          MONTHS: ${{ inputs.months }}
        run: |
          cd ml-api
          python scripts/collect_all_transactions.py \
            --group $REGION_GROUP \
            --mode $COLLECTION_MODE \
            --months $MONTHS

      - name: Upload collection logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collection-logs-group-${{ matrix.region_group }}
          path: ml-api/logs/
          retention-days: 7

  collect-supplementary:
    name: ë³´ì¡° ë°ì´í„° ìˆ˜ì§‘
    runs-on: ubuntu-latest
    needs: collect-all-data

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Collect REB price index
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          REB_API_KEY: ${{ secrets.REB_API_KEY }}
        run: |
          cd ml-api
          python scripts/collect_reb_index.py --all-regions

      - name: Collect footfall data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SBIZ_API_KEY: ${{ secrets.SBIZ_API_KEY }}
        run: |
          cd ml-api
          python scripts/collect_footfall_all.py

      - name: Collect POI data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
        run: |
          cd ml-api
          python scripts/collect_poi_data.py --all-regions

  train-model:
    name: ML ëª¨ë¸ í•™ìŠµ
    runs-on: ubuntu-latest
    needs: collect-supplementary
    if: inputs.skip_training == false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Prepare training data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd ml-api
          python scripts/prepare_training_data.py --full --output data/training_data.csv

      - name: Train XGBoost model
        run: |
          cd ml-api
          python scripts/train_model.py --csv data/training_data.csv

      - name: Generate SHAP analysis
        run: |
          cd ml-api
          echo "SHAP analysis is generated during training"
          ls -la app/models/ || echo "Models directory check"

      - name: Upload model to Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          cd ml-api
          python scripts/upload_model.py

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ml-models-full
          path: |
            ml-api/models/*.joblib
            ml-api/models/*.json
            ml-api/reports/
          retention-days: 30

  summary:
    name: ì™„ë£Œ ìš”ì•½
    runs-on: ubuntu-latest
    needs: [collect-all-data, collect-supplementary, train-model]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ  ì „êµ­ ë°ì´í„° ìˆ˜ì§‘ & ML í•™ìŠµ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ì‹¤í–‰ ì„¤ì •" >> $GITHUB_STEP_SUMMARY
          echo "- ëŒ€ìƒ: ${{ inputs.regions }}" >> $GITHUB_STEP_SUMMARY
          echo "- ê¸°ê°„: ${{ inputs.months }}ê°œì›”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ì‹¤ê±°ëž˜ê°€ ìˆ˜ì§‘: ${{ needs.collect-all-data.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ë³´ì¡° ë°ì´í„°: ${{ needs.collect-supplementary.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ML í•™ìŠµ: ${{ needs.train-model.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ì™„ë£Œ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
