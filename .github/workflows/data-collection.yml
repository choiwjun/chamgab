name: Daily Data Collection

on:
  schedule:
    # 매일 한국시간 06:00 (UTC 21:00) - 실거래가 수집
    - cron: '0 21 * * *'
    # 월요일 - REB 가격지수
    - cron: '0 21 * * 1'
    # 화요일 - 건축물대장
    - cron: '0 21 * * 2'
    # 수요일 - 유동인구
    - cron: '0 21 * * 3'
  workflow_dispatch: # 수동 실행 가능

env:
  PYTHON_VERSION: '3.11'

jobs:
  collect-transactions:
    name: 실거래가 수집
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Collect transaction data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          MOLIT_API_KEY: ${{ secrets.DATA_GO_KR_API_KEY }}
          REB_API_KEY: ${{ secrets.REB_API_KEY }}
        run: |
          cd ml-api
          python -c "
          from app.services.collector_service import CollectorService
          from datetime import datetime
          import asyncio

          async def main():
              collector = CollectorService()
              now = datetime.now()
              year = now.year
              # 최근 3개월
              months = [(now.month - i - 1) % 12 + 1 for i in range(3)]
              job_id = f'daily_{now.strftime(\"%Y%m%d\")}'

              # 주요 지역만 수집 (전국은 시간이 오래 걸림)
              key_regions = ['11680', '11650', '11710', '41135', '41117']  # 강남, 서초, 송파, 분당, 영통
              result = await collector.collect_regions(key_regions, year, months, job_id)
              print(f'Collected MOLIT: {result[\"molit_count\"]}, R-ONE: {result[\"rone_count\"]}')

          asyncio.run(main())
          "

  collect-reb-index:
    name: REB 가격지수 수집
    runs-on: ubuntu-latest
    # 월요일에만 실행 (주간 지수)
    if: github.event.schedule == '0 21 * * 1' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Collect REB price index
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          REB_API_KEY: ${{ secrets.REB_API_KEY }}
        run: |
          cd ml-api
          python -c "
          from app.services.market_service import MarketService
          from datetime import datetime

          service = MarketService()
          now = datetime.now()

          # 주요 지역 시장 피처 수집
          key_regions = ['강남구', '서초구', '송파구', '분당구', '영통구']
          for sigungu in key_regions:
              result = service.get_market_features(now.year, now.month, sigungu)
              print(f'{sigungu}: {result}')

          print('REB price index collection done')
          "

  collect-building-info:
    name: 건축물대장 수집
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # 화요일에만 실행 (주간) - 건물 정보는 자주 변하지 않음
    if: github.event.schedule == '0 21 * * 2' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Collect building registry data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          DATA_GO_KR_API_KEY: ${{ secrets.DATA_GO_KR_API_KEY }}
        run: |
          cd ml-api
          python scripts/collect_building_info.py

  collect-footfall:
    name: 유동인구 데이터 수집
    runs-on: ubuntu-latest
    # 수요일에만 실행 (주간)
    if: github.event.schedule == '0 21 * * 3' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ml-api/requirements.txt

      - name: Install dependencies
        run: |
          cd ml-api
          pip install -r requirements.txt

      - name: Collect footfall data
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          PUBLIC_DATA_API_KEY: ${{ secrets.SBIZ_API_KEY }}
        run: |
          cd ml-api
          python -c "
          from app.services.footfall_service import FootfallService

          service = FootfallService()
          # 주요 지역 유동인구 피처 확인
          test_locations = [
              (37.5172, 127.0473, '강남역'),
              (37.4979, 127.0276, '서초역'),
              (37.5138, 127.1004, '잠실역'),
          ]
          for lat, lng, name in test_locations:
              features = service.get_footfall_features(lat=lat, lng=lng, radius=500)
              print(f'{name}: footfall_score={features[\"footfall_score\"]}')

          print('Footfall data collection done')
          "

  notify-completion:
    name: 완료 알림
    needs: [collect-transactions, collect-reb-index, collect-building-info, collect-footfall]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Data collection completed at $(date)"
          echo "Transaction collection: ${{ needs.collect-transactions.result }}"
          echo "REB index: ${{ needs.collect-reb-index.result }}"
          echo "Building info: ${{ needs.collect-building-info.result }}"
          echo "Footfall: ${{ needs.collect-footfall.result }}"
